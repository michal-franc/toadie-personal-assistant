# Claude Watch

Bi-directional voice-to-Claude pipeline: Speak into your Galaxy Watch or phone, Claude Code executes your command, and responses come back as text notifications or TTS audio. Includes permission prompts for dangerous operations.

![Dashboard Screenshot](web_ui.jpg)

## Architecture

![Architecture Diagram](docs/architecture.jpg)
*Diagram generated by Claude*

1. **Watch/Phone App** - Record voice or type text
2. **Server** - HTTP (port 5566) + WebSocket (port 5567)
3. **Deepgram** - Transcribes audio to text (STT) and text to speech (TTS)
4. **Claude Code** - Persistent process with JSON streaming I/O
5. **Permission Hook** - Intercepts dangerous operations for approval
6. **Response** - Text notification or audio playback

## Components

| Component | Description |
|-----------|-------------|
| `server.py` | HTTP/WebSocket server, request handling, TTS |
| `claude_wrapper.py` | Persistent Claude process with JSON streaming |
| `permission_hook.py` | Tool approval system for sensitive operations |
| `dashboard.html` | Vue.js 3 web dashboard |
| `watch-app/` | Kotlin Wear OS app |
| `phone-app/` | Kotlin Android companion app |

## Setup

### 1. Dependencies

```bash
pip install deepgram-sdk aiohttp
```

System requirements: `alacritty`, `tmux`

### 2. Deepgram API Key

Get your API key from https://deepgram.com and store it:

```bash
echo "your-api-key" > /tmp/deepgram_api_key
```

### 3. Start the Server

```bash
./server.py /path/to/your/project
```

The server requires a working directory argument - this is where Claude Code will operate.

- HTTP server: `http://localhost:5566`
- WebSocket: `ws://localhost:5567/ws`
- Dashboard: http://localhost:5566

### 4. Install Apps

**Watch App (Wear OS):**
```bash
cd watch-app
./gradlew assembleDebug
adb install -r app/build/outputs/apk/debug/app-debug.apk
```

**Phone App (Android):**
```bash
cd phone-app
./gradlew assembleDebug
adb install -r app/build/outputs/apk/debug/app-debug.apk
```

Configure server IP in each app's settings.

## Server Endpoints

### HTTP (port 5566)

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/` | GET | Web dashboard |
| `/transcribe` | POST | Receive audio, transcribe, launch Claude |
| `/api/history` | GET | Request history with workflow steps |
| `/api/chat` | GET | Chat history, Claude state, current prompt |
| `/api/config` | GET/POST | Transcription and response settings |
| `/api/message` | POST | Send text message (phone app) |
| `/api/response/<id>` | GET | Poll for Claude's response |
| `/api/response/<id>/ack` | POST | Watch confirms receipt |
| `/api/audio/<id>` | GET | Download TTS audio file |
| `/api/permission/request` | POST | Hook submits permission request |
| `/api/permission/status/<id>` | GET | Hook polls for decision |
| `/api/permission/respond` | POST | Mobile app approves/denies |
| `/health` | GET | Health check |

### WebSocket (port 5567)

Connect to `ws://server:5567/ws` for real-time updates.

**Message Types:**
| Type | Description |
|------|-------------|
| `state` | Claude status (idle, listening, thinking, speaking) |
| `chat` | New chat message |
| `history` | Full chat history on connect |
| `permission` | Permission request for tool execution |
| `permission_resolved` | Permission decision made |
| `usage` | Context usage stats (tokens, cost) |

## Permission System

Dangerous operations require approval via the permission hook.

**Sensitive Tools (require approval):**
- Bash (except safe commands)
- Write, Edit, NotebookEdit

**Auto-approved:**
- Read, Glob, Grep
- Safe Bash: `ls`, `cat`, `head`, `tail`, `grep`, `find`, `echo`, `pwd`, `whoami`, `date`, `which`, `type`, `file`

When a sensitive tool is invoked:
1. Permission hook sends request to server
2. Server broadcasts to connected mobile apps
3. User approves or denies
4. Hook receives decision and proceeds

## Response Modes

Configure via dashboard settings:

- **disabled** - No response sent to watch (default)
- **text** - Send text notification to watch
- **audio** - Generate TTS audio, watch plays it

## Configuration

Transcription settings via web dashboard or API:

- **Model**: nova-3, nova-2, nova, enhanced, base
- **Language**: en-US, pl
- **Smart Format**: Auto-format numbers, dates
- **Punctuate**: Add punctuation

## Testing

```bash
# Run all tests
pytest

# Run specific test file
pytest test_server.py
pytest test_claude_wrapper.py
pytest test_permission_hook.py

# Health check
curl http://localhost:5566/health

# Send audio file
curl -X POST http://localhost:5566/transcribe \
  -H "Content-Type: audio/mp4" \
  --data-binary @recording.m4a

# Send text message
curl -X POST http://localhost:5566/api/message \
  -H "Content-Type: application/json" \
  -d '{"message": "list files in current directory"}'
```

## Troubleshooting

**400 Bad Request:**
- Make sure you're using `http://` not `https://`
- Check that audio is in the request body

**No transcript:**
- Check Deepgram API key is valid
- Verify audio format (m4a, wav, mp3 supported)

**Claude doesn't respond:**
- Check tmux session: `tmux attach -t claude-watch`
- View logs: `tail -f /tmp/claude-watch.log`

**Permission prompts not showing:**
- Ensure phone app is connected via WebSocket
- Check server logs for permission broadcasts

**Watch can't connect:**
- Verify server IP is correct in watch app settings
- Ensure watch and server are on same network

## Files

```
claude-watch/
├── server.py              # HTTP/WebSocket server
├── claude_wrapper.py      # Persistent Claude process manager
├── permission_hook.py     # Tool approval hook
├── logger.py              # Logging configuration
├── dashboard.html         # Vue.js web dashboard
├── watch-app/             # Kotlin Wear OS app
├── phone-app/             # Kotlin Android companion app
├── test_server.py         # Server unit tests
├── test_claude_wrapper.py # Claude wrapper tests
├── test_permission_hook.py# Permission hook tests
├── docs/                  # Diagrams and mockups
├── CLAUDE.md              # Project context for Claude Code
└── README.md              # This file
```

## Logs

- `/tmp/claude-watch.log` - Main server log (DEBUG level)
- `/tmp/claude-watch-tts.log` - TTS debug log
- `/tmp/claude-watch-output.log` - Claude output stream
- Console shows INFO level and above
