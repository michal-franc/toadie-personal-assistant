<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claude Watch Dashboard</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #333;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    h1 {
      font-size: 1.5rem;
      font-weight: 600;
    }
    .workdir {
      font-size: 0.85rem;
      color: #888;
      font-family: monospace;
      background: #252540;
      padding: 6px 12px;
      border-radius: 4px;
    }
    .settings-btn {
      background: #252540;
      border: 1px solid #333;
      color: #888;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .settings-btn:hover {
      background: #333;
      color: #eee;
    }
    .status-bar {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
      font-size: 0.9rem;
    }
    .status-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    .dot.green { background: #4ade80; }
    .dot.yellow { background: #facc15; }
    .dot.red { background: #f87171; }
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .history-item {
      background: #252540;
      border-radius: 8px;
      padding: 16px;
      border-left: 4px solid #666;
    }
    .history-item.completed { border-left-color: #4ade80; }
    .history-item.no_speech { border-left-color: #facc15; }
    .history-item.error { border-left-color: #f87171; }
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .history-id {
      font-weight: 600;
      color: #888;
    }
    .input-type-badge {
      font-size: 0.9rem;
      margin-left: 6px;
    }
    .input-type-badge.voice {
      color: #60a5fa;
    }
    .input-type-badge.text {
      color: #a78bfa;
    }
    .input-type-badge.terminal {
      color: #34d399;
    }
    .history-time {
      font-size: 0.8rem;
      color: #666;
    }
    .history-duration {
      font-size: 0.75rem;
      color: #4ade80;
      background: #166534;
      padding: 2px 8px;
      border-radius: 4px;
      margin-left: 8px;
    }
    .step-duration {
      font-size: 0.6rem;
      color: #888;
      margin-top: 2px;
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }
    .error-msg {
      color: #f87171;
      font-size: 0.85rem;
      margin-top: 8px;
    }
    .refresh-btn {
      background: #333;
      border: none;
      color: #eee;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .refresh-btn:hover {
      background: #444;
    }
    .auto-refresh {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: #888;
    }

    /* Workflow Timeline */
    .workflow {
      display: flex;
      align-items: flex-start;
      gap: 0;
      margin-bottom: 12px;
    }
    .workflow-step {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      cursor: pointer;
    }
    .workflow-step:hover .step-icon {
      transform: scale(1.15);
    }
    .workflow-step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 12px;
      left: 50%;
      width: 100%;
      height: 2px;
      background: #333;
      z-index: 0;
    }
    .workflow-step.completed:not(:last-child)::after {
      background: #4ade80;
    }
    .workflow-step.error:not(:last-child)::after {
      background: #f87171;
    }
    .workflow-step.in_progress:not(:last-child)::after {
      background: #60a5fa;
    }
    .step-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      z-index: 1;
      position: relative;
      transition: transform 0.15s ease;
    }
    .workflow-step.completed .step-icon {
      background: #166534;
      color: #4ade80;
    }
    .workflow-step.skipped .step-icon {
      background: #854d0e;
      color: #facc15;
    }
    .workflow-step.error .step-icon {
      background: #991b1b;
      color: #f87171;
    }
    .workflow-step.pending .step-icon {
      background: #333;
      color: #666;
    }
    .workflow-step.in_progress .step-icon {
      background: #1e3a5f;
      color: #60a5fa;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .step-label {
      font-size: 0.7rem;
      color: #888;
      margin-top: 6px;
      text-align: center;
    }
    .workflow-step.completed .step-label {
      color: #4ade80;
    }
    .workflow-step.error .step-label {
      color: #f87171;
    }
    .workflow-step.in_progress .step-label {
      color: #60a5fa;
    }

    /* Permission step styling */
    .workflow-step.permission .step-icon {
      background: #78350f;
      color: #f59e0b;
    }
    .workflow-step.permission .step-label {
      color: #f59e0b;
    }
    .workflow-step.permission:not(:last-child)::after {
      background: #f59e0b;
    }

    /* Tool step styling */
    .workflow-step.tool .step-icon {
      background: #1e3a5f;
      color: #60a5fa;
    }
    .workflow-step.tool .step-label {
      color: #60a5fa;
      font-size: 0.6rem;
    }
    .workflow-step.tool:not(:last-child)::after {
      background: #60a5fa;
    }

    /* Transcript preview */
    .transcript-preview {
      font-size: 0.9rem;
      color: #ccc;
      padding: 8px 12px;
      background: #1a1a2e;
      border-radius: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .transcript-preview.empty {
      color: #666;
      font-style: italic;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .modal {
      background: #252540;
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #333;
    }
    .modal-title {
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .modal-close {
      background: none;
      border: none;
      color: #888;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
    .modal-close:hover {
      color: #eee;
    }
    .modal-row {
      display: flex;
      margin-bottom: 12px;
      align-items: center;
    }
    .modal-label {
      width: 100px;
      color: #888;
      font-size: 0.85rem;
      flex-shrink: 0;
    }
    .modal-value {
      flex: 1;
      font-size: 0.9rem;
      word-break: break-word;
    }
    .modal-value.mono {
      font-family: monospace;
      background: #1a1a2e;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .modal-transcript {
      background: #1a1a2e;
      padding: 12px;
      border-radius: 6px;
      font-size: 0.95rem;
      line-height: 1.6;
      margin-top: 8px;
    }
    .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .status-badge.completed {
      background: #166534;
      color: #4ade80;
    }
    .status-badge.skipped {
      background: #854d0e;
      color: #facc15;
    }
    .status-badge.error {
      background: #991b1b;
      color: #f87171;
    }
    .status-badge.in_progress {
      background: #1e3a5f;
      color: #60a5fa;
    }

    /* Settings form */
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      color: #888;
      font-size: 0.85rem;
      margin-bottom: 6px;
    }
    .form-group select,
    .form-group input[type="text"] {
      width: 100%;
      padding: 8px 12px;
      background: #1a1a2e;
      border: 1px solid #333;
      border-radius: 4px;
      color: #eee;
      font-size: 0.9rem;
    }
    .form-group select:focus,
    .form-group input:focus {
      outline: none;
      border-color: #4ade80;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .checkbox-group input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }
    .checkbox-group label {
      margin: 0;
      color: #ccc;
    }
    .form-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid #333;
    }
    .btn {
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 0.9rem;
      cursor: pointer;
      border: none;
    }
    .btn-primary {
      background: #166534;
      color: #4ade80;
    }
    .btn-primary:hover {
      background: #15803d;
    }
    .btn-secondary {
      background: #333;
      color: #eee;
    }
    .btn-secondary:hover {
      background: #444;
    }
    .config-badge {
      font-size: 0.7rem;
      color: #666;
      background: #1a1a2e;
      padding: 2px 6px;
      border-radius: 3px;
      margin-left: 8px;
    }

    /* Chat Section */
    .chat-section {
      background: #252540;
      border-radius: 8px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #1a1a2e;
      border-bottom: 1px solid #333;
    }
    .chat-title {
      font-size: 0.95rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .chat-state {
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 4px;
      text-transform: uppercase;
    }
    .chat-state.idle { background: #333; color: #888; }
    .chat-state.listening { background: #1e3a5f; color: #60a5fa; }
    .chat-state.thinking { background: #854d0e; color: #facc15; animation: pulse 1.5s infinite; }
    .chat-state.speaking { background: #166534; color: #4ade80; }
    .chat-messages {
      max-height: 300px;
      overflow-y: auto;
      padding: 12px;
    }
    .chat-message {
      margin-bottom: 12px;
      padding: 10px 14px;
      border-radius: 8px;
      max-width: 85%;
    }
    .chat-message:last-child {
      margin-bottom: 0;
    }
    .chat-message.user {
      background: #1e3a5f;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }
    .chat-message.claude {
      background: #1a1a2e;
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }
    .chat-message-role {
      font-size: 0.7rem;
      color: #888;
      margin-bottom: 4px;
      text-transform: uppercase;
    }
    .chat-message.user .chat-message-role { color: #60a5fa; }
    .chat-message.claude .chat-message-role { color: #4ade80; }
    .chat-message-content {
      font-size: 0.9rem;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .chat-message-time {
      font-size: 0.65rem;
      color: #666;
      margin-top: 6px;
      text-align: right;
    }
    .chat-empty {
      text-align: center;
      padding: 30px;
      color: #666;
      font-size: 0.9rem;
    }
    .section-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: #888;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Prompt UI */
    .prompt-box {
      background: #1e3a5f;
      border: 1px solid #60a5fa;
      border-radius: 8px;
      padding: 16px;
      margin: 12px;
    }
    .prompt-title {
      font-size: 0.75rem;
      color: #60a5fa;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      font-weight: 600;
    }
    .prompt-context {
      font-family: monospace;
      font-size: 0.85rem;
      color: #ccc;
      background: #1a1a2e;
      padding: 8px 12px;
      border-radius: 4px;
      margin-bottom: 12px;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .prompt-question {
      font-size: 1rem;
      font-weight: 600;
      color: #fff;
      margin-bottom: 12px;
    }
    .prompt-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .prompt-option {
      background: #252540;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 10px 14px;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .prompt-option:hover {
      background: #333;
      border-color: #60a5fa;
    }
    .prompt-option.selected {
      border-color: #60a5fa;
      background: #1e3a5f;
    }
    .prompt-option-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .prompt-option-num {
      background: #333;
      color: #888;
      width: 20px;
      height: 20px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .prompt-option.selected .prompt-option-num {
      background: #60a5fa;
      color: #fff;
    }
    .prompt-option-label {
      font-size: 0.9rem;
      font-weight: 500;
      color: #eee;
    }
    .prompt-option-desc {
      font-size: 0.8rem;
      color: #888;
      margin-top: 4px;
      margin-left: 28px;
    }
    .chat-state.waiting { background: #1e3a5f; color: #60a5fa; animation: pulse 1.5s infinite; }
  </style>
</head>
<body>
  <div id="app" class="container">
    <header>
      <div class="header-left">
        <h1>Claude Watch</h1>
        <span class="config-badge" v-if="config.model">{{ config.model }} / {{ config.language }}</span>
      </div>
      <div style="display: flex; align-items: center; gap: 12px;">
        <div class="workdir" v-if="workdir">{{ workdir }}</div>
        <a href="/viewer" target="_blank" class="settings-btn" style="text-decoration: none;">
          <span>&#128065;</span> Viewer
        </a>
        <button class="settings-btn" @click="openSettings">
          <span>&#9881;</span> Settings
        </button>
      </div>
    </header>

    <div class="status-bar">
      <div class="status-item">
        <span class="dot green"></span>
        <span>{{ stats.completed }} completed</span>
      </div>
      <div class="status-item">
        <span class="dot yellow"></span>
        <span>{{ stats.noSpeech }} no speech</span>
      </div>
      <div class="status-item">
        <span class="dot red"></span>
        <span>{{ stats.errors }} errors</span>
      </div>
      <div style="flex: 1"></div>
      <div class="status-item" style="gap: 6px;">
        <span class="dot" :class="wsConnected ? 'green' : 'red'"></span>
        <span>WS</span>
        <span v-if="connectedClients.length" style="margin-left: 4px; color: #666;">|</span>
        <span v-for="c in connectedClients" :key="c.device_type + c.device_id + c.connected_at"
              :title="(c.device_id || c.device_type) + ' (' + c.ip + ')'"
              style="font-size: 0.85rem; cursor: default;">
          {{ c.device_type === 'phone' ? '&#128241;' : c.device_type === 'watch' ? '&#8986;' : c.device_type === 'dashboard' ? '&#128421;' : '&#10067;' }}
        </span>
      </div>
      <div class="auto-refresh">
        <input type="checkbox" id="autoRefresh" v-model="autoRefresh">
        <label for="autoRefresh">Auto-refresh</label>
      </div>
      <button class="refresh-btn" @click="fetchHistory">Refresh</button>
    </div>

    <div class="section-title">Request History</div>

    <div class="history-list" v-if="history.length > 0">
      <div
        v-for="item in history"
        :key="item.id"
        class="history-item"
        :class="item.status"
      >
        <div class="history-header">
          <span class="history-id">#{{ item.id }}</span>
          <span class="input-type-badge" :class="item.input_type || 'voice'">
            {{ item.input_type === 'terminal' ? 'ðŸ’»' : (item.input_type || 'voice') === 'voice' ? 'ðŸŽ¤' : 'ðŸ’¬' }}
          </span>
          <div>
            <span class="history-time">{{ formatTime(item.timestamp) }}</span>
            <span class="history-duration" v-if="getTotalDuration(item)">{{ getTotalDuration(item) }}</span>
          </div>
        </div>

        <!-- Workflow Timeline -->
        <div class="workflow" v-if="item.steps && item.steps.length > 0">
          <div
            v-for="(step, index) in item.steps"
            :key="index"
            class="workflow-step"
            :class="[step.status, { permission: step.name === 'permission' && step.status === 'in_progress', tool: step.name === 'tool' }]"
            @click="openModal(item, step)"
          >
            <div class="step-icon">
              <span v-if="step.name === 'permission' && step.status === 'in_progress'">&#x1F6E1;</span>
              <span v-else-if="step.name === 'tool'">&#128295;</span>
              <span v-else-if="step.status === 'completed'">&#10003;</span>
              <span v-else-if="step.status === 'error'">&#10005;</span>
              <span v-else-if="step.status === 'skipped'">&#8211;</span>
              <span v-else-if="step.status === 'in_progress'">&#8987;</span>
              <span v-else>{{ index + 1 }}</span>
            </div>
            <div class="step-label">{{ step.label }}</div>
            <div class="step-duration" v-if="getStepDuration(item, index)">{{ getStepDuration(item, index) }}</div>
          </div>
        </div>

        <!-- Transcript Preview -->
        <div class="transcript-preview" v-if="item.transcript">
          {{ item.transcript }}
        </div>
        <div class="transcript-preview empty" v-else>
          No speech detected
        </div>

        <div class="error-msg" v-if="item.error">{{ item.error }}</div>
      </div>
    </div>

    <div class="empty-state" v-else>
      <p>No requests yet</p>
      <p style="margin-top: 8px; font-size: 0.9rem;">Send audio to /transcribe or text to /api/message</p>
    </div>

    <!-- Step Details Modal -->
    <div class="modal-overlay" v-if="modal.visible" @click.self="closeModal">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title">
            <span>{{ modal.step?.label }}</span>
            <span class="status-badge" :class="modal.step?.status">{{ modal.step?.status }}</span>
          </div>
          <button class="modal-close" @click="closeModal">&times;</button>
        </div>

        <!-- Received step -->
        <template v-if="modal.step?.name === 'received'">
          <div class="modal-row">
            <span class="modal-label">Timestamp</span>
            <span class="modal-value">{{ formatFullTime(modal.step.timestamp) }}</span>
          </div>
          <div class="modal-row">
            <span class="modal-label">Size</span>
            <span class="modal-value mono">{{ formatSize(modal.item?.size_bytes) }}</span>
          </div>
          <div class="modal-row">
            <span class="modal-label">Content-Type</span>
            <span class="modal-value mono">{{ modal.item?.content_type }}</span>
          </div>
        </template>

        <!-- Sending step -->
        <template v-if="modal.step?.name === 'sending'">
          <div class="modal-row">
            <span class="modal-label">Timestamp</span>
            <span class="modal-value">{{ formatFullTime(modal.step.timestamp) }}</span>
          </div>
          <div class="modal-row">
            <span class="modal-label">Service</span>
            <span class="modal-value">Deepgram API</span>
          </div>
          <div class="modal-row">
            <span class="modal-label">Model</span>
            <span class="modal-value mono">{{ config.model }}</span>
          </div>
          <div class="modal-row">
            <span class="modal-label">Language</span>
            <span class="modal-value mono">{{ config.language }}</span>
          </div>
        </template>

        <!-- Transcribed step -->
        <template v-if="modal.step?.name === 'transcribed'">
          <div class="modal-row">
            <span class="modal-label">Timestamp</span>
            <span class="modal-value">{{ formatFullTime(modal.step.timestamp) }}</span>
          </div>
          <div class="modal-row" v-if="modal.step.duration_ms">
            <span class="modal-label">Duration</span>
            <span class="modal-value">{{ modal.step.duration_ms }}ms</span>
          </div>
          <div class="modal-row">
            <span class="modal-label">Transcript</span>
          </div>
          <div class="modal-transcript" v-if="modal.item?.transcript">
            {{ modal.item.transcript }}
          </div>
          <div class="modal-transcript" v-else style="color: #666; font-style: italic;">
            No speech detected
          </div>
        </template>

        <!-- Claude step -->
        <template v-if="modal.step?.name === 'claude'">
          <div class="modal-row">
            <span class="modal-label">Timestamp</span>
            <span class="modal-value">{{ formatFullTime(modal.step.timestamp) }}</span>
          </div>
          <div class="modal-row">
            <span class="modal-label">Action</span>
            <span class="modal-value">{{ modal.step.details }}</span>
          </div>
          <div class="modal-row" v-if="modal.item?.claude_launched">
            <span class="modal-label">Working Dir</span>
            <span class="modal-value mono">{{ workdir }}</span>
          </div>
        </template>

        <!-- Waiting for response step -->
        <template v-if="modal.step?.name === 'waiting_response'">
          <div class="modal-row">
            <span class="modal-label">Timestamp</span>
            <span class="modal-value">{{ formatFullTime(modal.step.timestamp) }}</span>
          </div>
          <div class="modal-row">
            <span class="modal-label">Status</span>
            <span class="modal-value">{{ modal.step.details }}</span>
          </div>
          <div style="font-size: 0.8rem; color: #888; margin-top: 12px;">
            Monitoring tmux session for Claude's response...
          </div>
        </template>

        <!-- Response captured step -->
        <template v-if="modal.step?.name === 'response_captured'">
          <div class="modal-row">
            <span class="modal-label">Timestamp</span>
            <span class="modal-value">{{ formatFullTime(modal.step.timestamp) }}</span>
          </div>
          <div class="modal-row">
            <span class="modal-label">Response</span>
          </div>
          <div class="modal-transcript">
            {{ modal.step.details }}
          </div>
        </template>

        <!-- TTS generating step -->
        <template v-if="modal.step?.name === 'tts_generating'">
          <div class="modal-row">
            <span class="modal-label">Timestamp</span>
            <span class="modal-value">{{ formatFullTime(modal.step.timestamp) }}</span>
          </div>
          <div class="modal-row">
            <span class="modal-label">Service</span>
            <span class="modal-value">Deepgram TTS</span>
          </div>
          <div class="modal-row">
            <span class="modal-label">Status</span>
            <span class="modal-value">{{ modal.step.details }}</span>
          </div>
        </template>

        <!-- Response ready step -->
        <template v-if="modal.step?.name === 'response_ready'">
          <div class="modal-row">
            <span class="modal-label">Timestamp</span>
            <span class="modal-value">{{ formatFullTime(modal.step.timestamp) }}</span>
          </div>
          <div class="modal-row">
            <span class="modal-label">Type</span>
            <span class="modal-value">{{ modal.step.details }}</span>
          </div>
          <div style="font-size: 0.8rem; color: #4ade80; margin-top: 12px;">
            âœ“ Response ready - watch can poll /api/response/{{ modal.item?.request_id }}
          </div>
        </template>

        <!-- Response disabled step -->
        <template v-if="modal.step?.name === 'response_disabled'">
          <div class="modal-row">
            <span class="modal-label">Timestamp</span>
            <span class="modal-value">{{ formatFullTime(modal.step.timestamp) }}</span>
          </div>
          <div class="modal-row">
            <span class="modal-label">Reason</span>
            <span class="modal-value">{{ modal.step.details }}</span>
          </div>
        </template>

        <!-- Watch received step -->
        <template v-if="modal.step?.name === 'watch_received'">
          <div class="modal-row">
            <span class="modal-label">Timestamp</span>
            <span class="modal-value">{{ formatFullTime(modal.step.timestamp) }}</span>
          </div>
          <div class="modal-row">
            <span class="modal-label">Status</span>
            <span class="modal-value">{{ modal.step.details }}</span>
          </div>
          <div style="font-size: 0.8rem; color: #4ade80; margin-top: 12px;">
            &#10003; Watch acknowledged receipt of response
          </div>
        </template>

        <!-- Response broadcast step -->
        <template v-if="modal.step?.name === 'response_broadcast'">
          <div class="modal-row">
            <span class="modal-label">Timestamp</span>
            <span class="modal-value">{{ formatFullTime(modal.step.timestamp) }}</span>
          </div>
          <div class="modal-row">
            <span class="modal-label">Delivery</span>
            <span class="modal-value">{{ modal.step.details }}</span>
          </div>
        </template>

        <!-- Permission step -->
        <template v-if="modal.step?.name === 'permission'">
          <div class="modal-row">
            <span class="modal-label">Timestamp</span>
            <span class="modal-value">{{ formatFullTime(modal.step.timestamp) }}</span>
          </div>
          <div class="modal-row">
            <span class="modal-label">Tool</span>
            <span class="modal-value mono">{{ modal.step.label?.replace('Permission: ', '') }}</span>
          </div>
          <div class="modal-row">
            <span class="modal-label">Context</span>
            <span class="modal-value">{{ modal.step.details }}</span>
          </div>
          <div class="modal-row" v-if="modal.step.status !== 'in_progress'">
            <span class="modal-label">Decision</span>
            <span class="modal-value" :style="{ color: modal.step.status === 'completed' ? '#4ade80' : '#f87171' }">
              {{ modal.step.status === 'completed' ? 'Allowed' : 'Denied' }}
            </span>
          </div>
          <div class="modal-row" v-if="modal.step.duration_ms">
            <span class="modal-label">Wait time</span>
            <span class="modal-value">{{ formatDuration(modal.step.duration_ms) }}</span>
          </div>
          <div v-if="modal.step.status === 'in_progress'" style="font-size: 0.8rem; color: #f59e0b; margin-top: 12px;">
            Waiting for user response...
          </div>
        </template>

        <!-- Tool step -->
        <template v-if="modal.step?.name === 'tool'">
          <div class="modal-row">
            <span class="modal-label">Timestamp</span>
            <span class="modal-value">{{ formatFullTime(modal.step.timestamp) }}</span>
          </div>
          <div class="modal-row">
            <span class="modal-label">Tool</span>
            <span class="modal-value mono">{{ modal.step.tool_name }}</span>
          </div>
          <div class="modal-row" v-if="modal.step.details">
            <span class="modal-label">Details</span>
            <span class="modal-value mono">{{ modal.step.details }}</span>
          </div>
        </template>

        <!-- Error step -->
        <template v-if="modal.step?.name === 'error' || modal.step?.error">
          <div class="modal-row">
            <span class="modal-label">Timestamp</span>
            <span class="modal-value">{{ formatFullTime(modal.step.timestamp) }}</span>
          </div>
          <div class="modal-row">
            <span class="modal-label">Error</span>
            <span class="modal-value" style="color: #f87171;">{{ modal.step.error || modal.step.details }}</span>
          </div>
        </template>
      </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" v-if="settingsModal.visible" @click.self="closeSettings">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title">Settings</div>
          <button class="modal-close" @click="closeSettings">&times;</button>
        </div>

        <div class="form-group">
          <label>Model</label>
          <select v-model="settingsModal.form.model">
            <option v-for="m in configOptions.models" :key="m" :value="m">{{ m }}</option>
          </select>
        </div>

        <div class="form-group">
          <label>Language</label>
          <select v-model="settingsModal.form.language">
            <option v-for="l in configOptions.languages" :key="l" :value="l">{{ l }}</option>
          </select>
        </div>

        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="smartFormat" v-model="settingsModal.form.smart_format">
            <label for="smartFormat">Smart Format</label>
          </div>
          <div style="font-size: 0.75rem; color: #666; margin-top: 4px;">
            Automatically format numbers, dates, etc.
          </div>
        </div>

        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="punctuate" v-model="settingsModal.form.punctuate">
            <label for="punctuate">Punctuate</label>
          </div>
          <div style="font-size: 0.75rem; color: #666; margin-top: 4px;">
            Add punctuation to transcript
          </div>
        </div>

        <div class="form-actions">
          <button class="btn btn-primary" @click="saveSettings">Save</button>
          <button class="btn btn-secondary" @click="closeSettings">Cancel</button>
          <div style="flex: 1"></div>
          <button class="btn" style="background: #dc3545; color: white;" @click="restartClaude">Restart Claude</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp, ref, computed, onMounted, onUnmounted } = Vue

    createApp({
      setup() {
        const history = ref([])
        const workdir = ref('')
        const autoRefresh = ref(true)
        const modal = ref({ visible: false, item: null, step: null })
        const config = ref({ model: '', language: '', smart_format: true, punctuate: true })
        const responseConfig = ref({ mode: 'text' })
        const configOptions = ref({ models: [], languages: [], response_modes: [] })
        const settingsModal = ref({
          visible: false,
          form: { model: '', language: '', smart_format: true, punctuate: true }
        })
        const chatMessages = ref([])
        const chatState = ref({ status: 'idle' })
        const chatContainer = ref(null)
        const currentPrompt = ref(null)
        const wsConnected = ref(false)
        const connectedClients = ref([])
        let intervalId = null
        let ws = null

        const stats = computed(() => ({
          completed: history.value.filter(h => h.status === 'completed').length,
          noSpeech: history.value.filter(h => h.status === 'no_speech').length,
          errors: history.value.filter(h => h.status === 'error').length
        }))

        const fetchHistory = async () => {
          try {
            const res = await fetch('/api/history')
            const data = await res.json()
            history.value = data.history
            workdir.value = data.workdir
          } catch (e) {
            console.error('Failed to fetch history:', e)
          }
        }

        const fetchConfig = async () => {
          try {
            const res = await fetch('/api/config')
            const data = await res.json()
            config.value = data.config
            responseConfig.value = data.response_config || { mode: 'text' }
            configOptions.value = data.options
          } catch (e) {
            console.error('Failed to fetch config:', e)
          }
        }

        const fetchChat = async () => {
          try {
            const res = await fetch('/api/chat')
            const data = await res.json()
            const wasAtBottom = chatContainer.value ?
              chatContainer.value.scrollHeight - chatContainer.value.scrollTop <= chatContainer.value.clientHeight + 50 : true
            const hadMessages = chatMessages.value.length
            chatMessages.value = data.messages || []
            chatState.value = data.state || { status: 'idle' }
            currentPrompt.value = data.prompt || null
            // Auto-scroll if new messages/prompt and was at bottom
            if ((chatMessages.value.length > hadMessages || currentPrompt.value) && wasAtBottom && chatContainer.value) {
              setTimeout(() => {
                chatContainer.value.scrollTop = chatContainer.value.scrollHeight
              }, 50)
            }
          } catch (e) {
            console.error('Failed to fetch chat:', e)
          }
        }

        const respondToPrompt = async (optionNum) => {
          try {
            const prompt = currentPrompt.value
            let res

            if (prompt && prompt.isPermission && prompt.request_id) {
              // Permission request - use permission endpoint
              const decision = optionNum === 1 ? 'allow' : 'deny'
              res = await fetch('/api/permission/respond', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  request_id: prompt.request_id,
                  decision: decision
                })
              })
            } else {
              // Regular prompt - use prompt endpoint
              res = await fetch('/api/prompt/respond', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ option: optionNum })
              })
            }

            const data = await res.json()
            if (data.status === 'ok') {
              currentPrompt.value = null
              // Refresh chat to get updated state
              fetchChat()
            } else {
              alert('Error: ' + (data.message || 'Unknown error'))
            }
          } catch (e) {
            console.error('Failed to respond to prompt:', e)
            alert('Failed to send response')
          }
        }

        const saveSettings = async () => {
          try {
            const res = await fetch('/api/config', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(settingsModal.value.form)
            })
            const data = await res.json()
            if (data.status === 'ok') {
              config.value = data.config
              responseConfig.value = data.response_config || responseConfig.value
              closeSettings()
            } else {
              alert('Error saving settings: ' + (data.errors?.join(', ') || data.message))
            }
          } catch (e) {
            console.error('Failed to save config:', e)
            alert('Failed to save settings')
          }
        }

        const restartClaude = async () => {
          if (!confirm('Restart Claude process? This will clear chat history.')) return
          try {
            const res = await fetch('/api/claude/restart', { method: 'POST' })
            const data = await res.json()
            if (data.status === 'restarted') {
              chatMessages.value = []
              closeSettings()
            } else {
              alert('Error: ' + (data.error || 'Unknown error'))
            }
          } catch (e) {
            alert('Failed to restart Claude')
          }
        }

        const formatTime = (iso) => {
          const d = new Date(iso)
          return d.toLocaleTimeString()
        }

        const formatFullTime = (iso) => {
          const d = new Date(iso)
          return d.toLocaleString()
        }

        const formatSize = (bytes) => {
          if (!bytes) return '0 B'
          if (bytes < 1024) return bytes + ' B'
          if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB'
          return (bytes / (1024 * 1024)).toFixed(1) + ' MB'
        }

        const formatDuration = (ms) => {
          if (ms < 1000) return ms + 'ms'
          if (ms < 60000) return (ms / 1000).toFixed(1) + 's'
          return (ms / 60000).toFixed(1) + 'm'
        }

        const getTotalDuration = (item) => {
          if (!item.steps || item.steps.length < 2) return null
          const firstStep = item.steps[0]
          const lastStep = item.steps[item.steps.length - 1]
          if (!firstStep.timestamp || !lastStep.timestamp) return null
          // Skip if last step is still in progress
          if (lastStep.status === 'in_progress') return null
          const start = new Date(firstStep.timestamp).getTime()
          const end = new Date(lastStep.timestamp).getTime()
          const duration = end - start
          if (duration <= 0) return null
          return formatDuration(duration)
        }

        const getStepDuration = (item, index) => {
          if (!item.steps || index === 0) return null
          const currentStep = item.steps[index]
          // Don't show duration for in_progress steps
          if (currentStep.status === 'in_progress') return null
          // Use explicit duration_ms if set on the step (e.g. permission steps)
          if (currentStep.duration_ms) return formatDuration(currentStep.duration_ms)
          const prevStep = item.steps[index - 1]
          if (!currentStep.timestamp || !prevStep.timestamp) return null
          const start = new Date(prevStep.timestamp).getTime()
          const end = new Date(currentStep.timestamp).getTime()
          const duration = end - start
          if (duration <= 0) return null
          return formatDuration(duration)
        }

        const openModal = (item, step) => {
          modal.value = { visible: true, item, step }
        }

        const closeModal = () => {
          modal.value = { visible: false, item: null, step: null }
        }

        const openSettings = () => {
          settingsModal.value.form = { ...config.value }
          settingsModal.value.visible = true
        }

        const closeSettings = () => {
          settingsModal.value.visible = false
        }

        const scrollChatToBottom = () => {
          if (chatContainer.value) {
            const c = chatContainer.value
            const wasAtBottom = c.scrollHeight - c.scrollTop <= c.clientHeight + 50
            if (wasAtBottom) {
              setTimeout(() => { c.scrollTop = c.scrollHeight }, 50)
            }
          }
        }

        const connectWebSocket = () => {
          const wsUrl = `ws://${window.location.hostname}:5567/ws?device=dashboard`
          ws = new WebSocket(wsUrl)

          ws.onopen = () => {
            wsConnected.value = true
            console.log('[WS] Connected')
          }

          ws.onclose = () => {
            wsConnected.value = false
            console.log('[WS] Disconnected, reconnecting...')
            setTimeout(connectWebSocket, 3000)
          }

          ws.onerror = (e) => {
            console.error('[WS] Error:', e)
          }

          ws.onmessage = (event) => {
            const msg = JSON.parse(event.data)

            switch (msg.type) {
              case 'state':
                chatState.value = { status: msg.status, request_id: msg.request_id }
                // Refresh history when state changes (captures step updates)
                if (autoRefresh.value) fetchHistory()
                break

              case 'history':
                // Full chat history on connect
                chatMessages.value = msg.messages || []
                scrollChatToBottom()
                break

              case 'chat':
                // New chat message
                chatMessages.value.push({
                  role: msg.role,
                  content: msg.content,
                  timestamp: msg.timestamp
                })
                while (chatMessages.value.length > 50) chatMessages.value.shift()
                scrollChatToBottom()
                break

              case 'permission':
                // Permission request - show prompt
                currentPrompt.value = {
                  question: msg.question,
                  context: msg.context,
                  title: msg.tool_name,
                  request_id: msg.request_id,
                  isPermission: true,
                  options: msg.options
                }
                scrollChatToBottom()
                if (autoRefresh.value) fetchHistory()
                break

              case 'permission_resolved':
                // Clear prompt if it matches
                if (currentPrompt.value && currentPrompt.value.request_id === msg.request_id) {
                  currentPrompt.value = null
                }
                if (autoRefresh.value) fetchHistory()
                break

              case 'clients':
                connectedClients.value = msg.clients || []
                break

              case 'usage':
                // Could display usage stats in the future
                break

              case 'text_chunk':
              case 'tool':
                // Refresh history to show updated steps
                if (autoRefresh.value) fetchHistory()
                break
            }
          }
        }

        const handleKeydown = (e) => {
          if (e.key === 'Escape') {
            if (modal.value.visible) closeModal()
            if (settingsModal.value.visible) closeSettings()
          }
        }

        onMounted(() => {
          fetchHistory()
          fetchConfig()
          fetchChat()
          connectWebSocket()
          // Keep polling history as fallback (less frequently since WS handles most updates)
          intervalId = setInterval(() => {
            if (autoRefresh.value) {
              fetchHistory()
            }
          }, 5000)
          document.addEventListener('keydown', handleKeydown)
        })

        onUnmounted(() => {
          if (intervalId) clearInterval(intervalId)
          if (ws) ws.close()
          document.removeEventListener('keydown', handleKeydown)
        })

        return {
          history,
          workdir,
          autoRefresh,
          modal,
          config,
          responseConfig,
          configOptions,
          settingsModal,
          chatMessages,
          chatState,
          chatContainer,
          currentPrompt,
          wsConnected,
          connectedClients,
          respondToPrompt,
          stats,
          fetchHistory,
          fetchChat,
          saveSettings,
          restartClaude,
          formatTime,
          formatFullTime,
          formatSize,
          formatDuration,
          getTotalDuration,
          getStepDuration,
          openModal,
          closeModal,
          openSettings,
          closeSettings
        }
      }
    }).mount('#app')
  </script>
</body>
</html>
